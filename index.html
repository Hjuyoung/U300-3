<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¾ ì˜ë†ì¼ì§€</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .logo-img {
            height: 50px;
            width: auto;
        }
        
        .header h1 {
            color: #15803d;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header-badge {
            background: #16a34a;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .nav button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #374151;
        }
        
        .nav button.active {
            background: #16a34a;
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .mode-switch {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .mode-switch button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
        }
        
        .mode-switch button.active {
            background: #16a34a;
            color: white;
        }
        
        .mic-container {
            text-align: center;
            padding: 2rem 0;
        }
        
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            font-size: 3rem;
            cursor: pointer;
            margin-bottom: 1rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            background: #16a34a;
            transition: all 0.2s;
        }
        
        .mic-button:hover {
            transform: scale(1.05);
        }
        
        .mic-button.listening {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .mic-status {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            resize: none;
            font-family: inherit;
            margin-bottom: 1rem;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            background: #16a34a;
            color: white;
        }
        
        .btn:hover {
            background: #15803d;
        }
        
        .info-box {
            background: #dbeafe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .info-box p {
            color: #1e40af;
            font-size: 0.9rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #bbf7d0;
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #bfdbfe;
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #e9d5ff;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸŒ¾ ìŒì„±ê¸°ë°˜ ë†ì‚°ë¬¼ì´ë ¥ì¶”ì ê´€ë¦¬ ë³´ê³ ì„œ ìƒì„±ì‹œìŠ¤í…œ<span class="header-badge">ì‘ì—…ì ëª¨ë“œ</span></h1>
                <p><strong>íŒ€ëª…:</strong> NDG | <strong>ì†Œì†:</strong> ì¬ëŠ¥ëŒ€í•™êµ</p>
                <p style="margin-top: 0.75rem; color: #6b7280;">ìŒì„±ì´ë‚˜ í…ìŠ¤íŠ¸ë¡œ ê°„í¸í•˜ê²Œ ì˜ë† í™œë™ì„ ê¸°ë¡í•˜ì„¸ìš”</p>
            </div>
            <div class="header-logo">
                <svg width="80" height="50" viewBox="0 0 80 50" xmlns="http://www.w3.org/2000/svg">
                    <!-- JEI ë¡œê³  (ë¹¨ê°„ìƒ‰) -->
                    <text x="5" y="38" font-family="Arial Black, Arial, sans-serif" font-size="32" font-weight="900" fill="#DC143C" letter-spacing="-1">JEI</text>
                </svg>
            </div>
        </div>

        <div class="nav">
            <button onclick="showTab('input')" class="active" id="btn-input">ğŸ“ ì¼ì§€ ì‘ì„±</button>
            <button onclick="showTab('list')" id="btn-list">ğŸ“… ëª©ë¡ (<span id="count">0</span>)</button>
            <button onclick="showTab('stats')" id="btn-stats">ğŸ“Š í†µê³„</button>
            <button onclick="showTab('report')" id="btn-report">ğŸ“‹ ì˜ë†ì¼ì§€</button>
        </div>

        <div id="content"></div>
    </div>

    <script>
        let records = [];
        let currentRecord = null;
        let recognition = null;
        let isListening = false;
        let inputMode = 'voice';

        // localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadData() {
            const saved = localStorage.getItem('farmRecords');
            if (saved) {
                records = JSON.parse(saved);
            }
            updateCount();
        }

        // localStorageì— ì €ì¥
        function saveData() {
            localStorage.setItem('farmRecords', JSON.stringify(records));
            updateCount();
        }

        // ê¸°ë¡ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateCount() {
            document.getElementById('count').textContent = records.length;
        }

        // íƒ­ ì „í™˜
        function showTab(tab) {
            document.getElementById('btn-input').classList.remove('active');
            document.getElementById('btn-list').classList.remove('active');
            document.getElementById('btn-stats').classList.remove('active');
            document.getElementById('btn-report').classList.remove('active');
            
            if (tab === 'input') {
                document.getElementById('btn-input').classList.add('active');
                showInputView();
            } else if (tab === 'list') {
                document.getElementById('btn-list').classList.add('active');
                showListView();
            } else if (tab === 'stats') {
                document.getElementById('btn-stats').classList.add('active');
                showStatsView();
            } else if (tab === 'report') {
                document.getElementById('btn-report').classList.add('active');
                showReportView();
            }
        }

        // ì…ë ¥ ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            inputMode = mode;
            showInputView();
        }

        // ì¼ì§€ ì‘ì„± í™”ë©´
        function showInputView() {
            let html = '<div class="card">';
            html += '<div class="mode-switch">';
            html += `<button class="${inputMode === 'voice' ? 'active' : ''}" onclick="switchMode('voice')">ğŸ¤ ìŒì„± ì…ë ¥</button>`;
            html += `<button class="${inputMode === 'text' ? 'active' : ''}" onclick="switchMode('text')">âŒ¨ï¸ í…ìŠ¤íŠ¸ ì…ë ¥</button>`;
            html += '</div>';

            if (inputMode === 'voice') {
                html += '<h3>ğŸ¤ ìŒì„±ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”</h3>';
                html += '<div class="mic-container">';
                html += '<button class="mic-button" onclick="toggleMic()">ğŸ¤</button>';
                html += '<p class="mic-status" id="mic-status">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì”€í•˜ì„¸ìš”</p>';
                html += '<p style="color: #6b7280; font-size: 0.9rem;">ì˜ˆ: "ì‚¬ê³¼ 100ìƒì ìˆ˜í™•í–ˆì–´ íŠ¹í’ˆ"</p>';
                html += '</div>';
                html += '<input type="text" id="input-text" style="display:none;">';
            } else {
                html += '<h3>ğŸ“ ì˜ë† í™œë™ ì…ë ¥</h3>';
                html += '<textarea id="input-text" rows="4" placeholder="ì˜ˆ: ì‚¬ê³¼ 100ìƒì ìˆ˜í™•í–ˆì–´, í¬ë„ 50í‚¬ë¡œ ë†í˜‘ì— ì¶œí•˜í–ˆì–´"></textarea>';
                html += '<button class="btn" onclick="analyzeText()">ğŸ”¨ ë¶„ì„í•˜ê¸°</button>';
            }

            html += '<div class="info-box">';
            html += '<p>ğŸ’¡ <strong>ì…ë ¥ ì˜ˆì‹œ:</strong></p>';
            html += '<p style="margin-top: 0.5rem;">â€¢ "ì‚¬ê³¼ ë°±ìƒì"</p>';
            html += '<p>â€¢ "í¬ë„ ìˆ˜í™•"</p>';
            html += '<p>â€¢ "í† ë§ˆí†  ì•½ì³¤ì–´"</p>';
            html += '<p>â€¢ "ë°°ì¶” íŒ”ì•˜ì–´"</p>';
            html += '<p>â€¢ "ë”¸ê¸° íŠ¹í’ˆ"</p>';
            html += '</div></div>';

            if (currentRecord) {
                html += '<div class="card">';
                html += '<h3>âœ… ìë™ ìƒì„±ëœ ì˜ë†ì¼ì§€</h3>';
                html += `<p style="margin-bottom: 1rem;">ì…ë ¥: "${currentRecord.rawText}"</p>`;
                html += '<div class="grid">';
                html += `<div class="stat-card green"><strong>ğŸŒ± ì‘ë¬¼:</strong> ${currentRecord.crop}</div>`;
                html += `<div class="stat-card blue"><strong>ğŸ”§ ì‘ì—…:</strong> ${currentRecord.task}</div>`;
                if (currentRecord.quantity) {
                    html += `<div class="stat-card purple"><strong>ğŸ“¦ ìˆ˜ëŸ‰:</strong> ${currentRecord.quantity}${currentRecord.unit}</div>`;
                }
                if (currentRecord.quality) {
                    html += `<div class="stat-card purple"><strong>â­ í’ˆì§ˆ:</strong> ${currentRecord.quality}</div>`;
                }
                if (currentRecord.buyer) {
                    html += `<div class="stat-card blue"><strong>ğŸª ì¶œí•˜ì²˜:</strong> ${currentRecord.buyer}</div>`;
                }
                if (currentRecord.storage) {
                    html += `<div class="stat-card green"><strong>ğŸ“¦ ì €ì¥:</strong> ${currentRecord.storage}</div>`;
                }
                html += '</div>';
                html += '<button class="btn" onclick="saveRecord()">ğŸ’¾ ì˜ë†ì¼ì§€ ì €ì¥í•˜ê¸°</button>';
                html += '</div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        // ëª©ë¡ í™”ë©´
        function showListView() {
            let html = '<div class="card"><h3>ğŸ“… ì˜ë†ì¼ì§€ ëª©ë¡</h3>';
            
            if (records.length === 0) {
                html += '<div class="empty-state">';
                html += '<div class="empty-icon">ğŸ”­</div>';
                html += '<p>ì•„ì§ ê¸°ë¡ëœ ì˜ë†ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                html += '</div>';
            } else {
                records.forEach(record => {
                    html += '<div style="border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">';
                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    html += `<span style="color: #6b7280;">${record.date}</span>`;
                    html += `<button onclick="deleteRecord(${record.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">ğŸ—‘ï¸</button>`;
                    html += '</div>';
                    html += `<p><strong>ğŸŒ± ${record.crop}</strong> | <strong>ğŸ”§ ${record.task}</strong>`;
                    if (record.quantity) html += ` | ğŸ“¦ ${record.quantity}${record.unit}`;
                    if (record.quality) html += ` | â­ ${record.quality}`;
                    if (record.buyer) html += ` | ğŸª ${record.buyer}`;
                    html += '</p>';
                    html += `<p style="color: #6b7280; font-style: italic; margin-top: 0.5rem;">"${record.rawText}"</p>`;
                    html += '</div>';
                });
            }
            
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        // í†µê³„ í™”ë©´
        function showStatsView() {
            if (records.length === 0) {
                document.getElementById('content').innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ“Š</div><p>í†µê³„ë¥¼ ë³´ë ¤ë©´ ë¨¼ì € ì˜ë†ì¼ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!</p></div></div>';
                return;
            }

            const cropCategories = {
                'ê³¼ìˆ˜ë¥˜': ['ì‚¬ê³¼', 'ë°°', 'í¬ë„', 'ê°', 'ë³µìˆ­ì•„', 'ìë‘', 'ë°¤', 'ëŒ€ì¶”', 'ë§¤ì‹¤', 'ì‚´êµ¬', 'ì•µë‘', 'ê°ê·¤', 'ê·¤', 'í•œë¼ë´‰', 'ì²œí˜œí–¥', 'ë ˆë“œí–¥', 'ë”¸ê¸°', 'ë¸”ë£¨ë² ë¦¬', 'í‚¤ìœ„', 'ë¬´í™”ê³¼', 'ì„ë¥˜', 'ì˜¤ë””'],
                'ì±„ì†Œë¥˜': ['í† ë§ˆí† ', 'ì˜¤ì´', 'ê³ ì¶”', 'ê°€ì§€', 'í˜¸ë°•', 'í”¼ë§', 'íŒŒí”„ë¦¬ì¹´', 'ìƒì¶”', 'ë°°ì¶”', 'ë¬´', 'ë‹¹ê·¼', 'ì–‘íŒŒ', 'ë§ˆëŠ˜', 'íŒŒ', 'ìª½íŒŒ', 'ëŒ€íŒŒ', 'ì‹œê¸ˆì¹˜', 'ê¹»ì', 'ë¸Œë¡œì½œë¦¬'],
                'ë‘ë¥˜/ì„œë¥˜': ['ì½©', 'ì™„ë‘ì½©', 'ê°•ë‚­ì½©', 'ë•…ì½©', 'ê°ì', 'ê³ êµ¬ë§ˆ', 'ê³ êµ¬ë§ˆìˆœ', 'ìƒê°•', 'ìš°ì—‰', 'ì—°ê·¼'],
                'ê³¡ë¬¼ë¥˜': ['ë²¼', 'ìŒ€', 'ë³´ë¦¬', 'ë°€', 'ì˜¥ìˆ˜ìˆ˜', 'íŒ¥', 'ë…¹ë‘', 'ìˆ˜ìˆ˜', 'ì¡°', 'ê¸°ì¥', 'ì°¸ê¹¨']
            };

            const categorizedCrops = {};
            const crops = new Set();
            const tasks = new Set();
            const qualities = {};
            const buyers = {};
            const storages = {};
            
            records.forEach(r => {
                if (r.crop !== 'ë¯¸ë¶„ë¥˜') {
                    crops.add(r.crop);
                    
                    // ì‘ë¬¼ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
                    let foundCategory = false;
                    for (const [category, cropList] of Object.entries(cropCategories)) {
                        if (cropList.includes(r.crop)) {
                            if (!categorizedCrops[category]) categorizedCrops[category] = new Set();
                            categorizedCrops[category].add(r.crop);
                            foundCategory = true;
                            break;
                        }
                    }
                    if (!foundCategory) {
                        if (!categorizedCrops['ê¸°íƒ€']) categorizedCrops['ê¸°íƒ€'] = new Set();
                        categorizedCrops['ê¸°íƒ€'].add(r.crop);
                    }
                }
                
                if (r.task !== 'ë¯¸ë¶„ë¥˜') tasks.add(r.task);
                if (r.quality) qualities[r.quality] = (qualities[r.quality] || 0) + 1;
                if (r.buyer) buyers[r.buyer] = (buyers[r.buyer] || 0) + 1;
                if (r.storage) storages[r.storage] = (storages[r.storage] || 0) + 1;
            });

            let html = '<div class="card">';
            html += '<h3>ğŸ“Š ì „ì²´ í†µê³„</h3>';
            html += '<div class="grid">';
            html += `<div class="stat-card green"><h2 style="font-size: 2.5rem; color: #15803d;">${crops.size}</h2><p>ì‘ë¬¼ ì¢…ë¥˜</p></div>`;
            html += `<div class="stat-card blue"><h2 style="font-size: 2.5rem; color: #1e40af;">${tasks.size}</h2><p>ì‘ì—… ì¢…ë¥˜</p></div>`;
            html += `<div class="stat-card purple"><h2 style="font-size: 2.5rem; color: #7c3aed;">${records.length}</h2><p>ì´ ê¸°ë¡</p></div>`;
            html += '</div></div>';

            // ì‘ë¬¼ ì¹´í…Œê³ ë¦¬ë³„ í‘œì‹œ
            const categoryIcons = {
                'ê³¼ìˆ˜ë¥˜': 'ğŸ',
                'ì±„ì†Œë¥˜': 'ğŸ¥¬',
                'ë‘ë¥˜/ì„œë¥˜': 'ğŸ¥”',
                'ê³¡ë¬¼ë¥˜': 'ğŸŒ¾',
                'ê¸°íƒ€': 'ğŸŒ¿'
            };

            html += '<div class="card"><h3>ğŸŒ± ì‘ë¬¼ ë¶„ë¥˜</h3>';
            
            for (const [category, cropSet] of Object.entries(categorizedCrops)) {
                const icon = categoryIcons[category] || 'ğŸŒ±';
                const cropArray = Array.from(cropSet);
                
                html += `<div style="margin-bottom: 1.5rem;">`;
                html += `<h4 style="color: #1f2937; font-size: 1.1rem; margin-bottom: 0.75rem; font-weight: 600;">${icon} ${category} (${cropArray.length}ì¢…)</h4>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                
                cropArray.forEach(crop => {
                    html += `<span style="background: #f0fdf4; color: #15803d; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #bbf7d0; font-weight: 500;">${crop}</span>`;
                });
                
                html += `</div></div>`;
            }
            
            html += '</div>';

            // ì‘ì—… ì¢…ë¥˜
            if (tasks.size > 0) {
                html += '<div class="card"><h3>ğŸ”§ ì‘ì—… ì¢…ë¥˜</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Array.from(tasks).forEach(task => {
                    html += `<span style="background: #eff6ff; color: #1e40af; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #bfdbfe; font-weight: 500;">${task}</span>`;
                });
                html += '</div></div>';
            }

            // í’ˆì§ˆ/ë“±ê¸‰
            if (Object.keys(qualities).length > 0) {
                html += '<div class="card"><h3>â­ í’ˆì§ˆ/ë“±ê¸‰</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(qualities).sort((a, b) => b[1] - a[1]).forEach(([q, count]) => {
                    html += `<span style="background: #fef2f2; color: #dc2626; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #fecaca; font-weight: 500;">${q} <span style="background: #dc2626; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}ê±´</span></span>`;
                });
                html += '</div></div>';
            }

            // ì €ì¥ ì¥ì†Œ
            if (Object.keys(storages).length > 0) {
                html += '<div class="card"><h3>ğŸ­ ì €ì¥ ì¥ì†Œ</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(storages).sort((a, b) => b[1] - a[1]).forEach(([s, count]) => {
                    html += `<span style="background: #faf5ff; color: #7c3aed; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #e9d5ff; font-weight: 500;">${s} <span style="background: #7c3aed; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}ê±´</span></span>`;
                });
                html += '</div></div>';
            }

            // ì¶œí•˜ì²˜/íŒë§¤ì²˜
            if (Object.keys(buyers).length > 0) {
                html += '<div class="card"><h3>ğŸª ì¶œí•˜ì²˜/íŒë§¤ì²˜</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(buyers).sort((a, b) => b[1] - a[1]).forEach(([b, count]) => {
                    html += `<span style="background: #fff7ed; color: #ea580c; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #fed7aa; font-weight: 500;">${b} <span style="background: #ea580c; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}ê±´</span></span>`;
                });
                html += '</div></div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initSpeech() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 5; // ë” ë§ì€ ëŒ€ì•ˆ ì œê³µ

                recognition.onresult = (event) => {
                    let text = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            text = event.results[i][0].transcript;
                            break;
                        }
                    }
                    
                    if (text) {
                        // í•œêµ­ì–´ ë°œìŒ ì •ê·œí™”
                        text = normalizePronunciation(text);
                        document.getElementById('input-text').value = text;
                        
                        // ìë™ ë¶„ì„ ë° ì €ì¥
                        analyzeText();
                        
                        // 1ì´ˆ í›„ ìë™ ì €ì¥ (ì‚¬ìš©ìê°€ í™•ì¸í•  ì‹œê°„ ì œê³µ)
                        setTimeout(() => {
                            if (currentRecord) {
                                saveRecord();
                            }
                        }, 1000);
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    const status = document.getElementById('mic-status');
                    if (status) status.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì”€í•˜ì„¸ìš”';
                };
            }
        }

        // í•œêµ­ì–´ ë°œìŒ ì •ê·œí™” í•¨ìˆ˜
        function normalizePronunciation(text) {
            // ë°›ì¹¨ ë°œìŒ ë³´ì •
            text = text.replace(/ìƒ¤ê³¼/g, 'ì‚¬ê³¼');
            text = text.replace(/ë¹ /g, 'ë°°');
            text = text.replace(/ë½€ë„/g, 'í¬ë„');
            text = text.replace(/ê¹œ/g, 'ê°');
            
            // ì´ì¤‘ëª¨ìŒ ë°œìŒ ë³´ì •
            text = text.replace(/ë°ì¶”/g, 'ëŒ€ì¶”');
            text = text.replace(/ë©”ì‹¤/g, 'ë§¤ì‹¤');
            text = text.replace(/íŒ¨/g, 'ë°°');
            
            // ëœì†Œë¦¬/ê±°ì„¼ì†Œë¦¬ ë³´ì •
            text = text.replace(/ê¹Œì§€/g, 'ê°€ì§€');
            text = text.replace(/ë¹ ì¶”/g, 'ë°°ì¶”');
            text = text.replace(/ë½€ê´€/g, 'ë³´ê´€');
            text = text.replace(/ì­ˆí•˜/g, 'ì¶œí•˜');
            
            // ë¹„ìŒí™” ë³´ì •
            text = text.replace(/ë†ë…¹/g, 'ë†í˜‘');
            text = text.replace(/ì‹­ë‹ˆë‹¤/g, 'ìŠµë‹ˆë‹¤');
            
            // êµ¬ì–´ì²´ ë°œìŒ ë³´ì •
            text = text.replace(/ìº£ì–´/g, 'ìº¤ì–´');
            text = text.replace(/ë•ƒì–´/g, 'ë•„ì–´');
            text = text.replace(/íŒ”ì•˜ì–´/g, 'íŒ”ì•˜ì–´');
            text = text.replace(/í–ˆì¨/g, 'í–ˆì–´');
            
            // ë°©ì–¸ ë³´ì • (ê²½ìƒë„)
            text = text.replace(/ì¹´ì´/g, 'ìº');
            text = text.replace(/ë­ë…¸/g, 'ë­ì•¼');
            text = text.replace(/~ì¹´ì´/g, '~ìº');
            
            // ë°©ì–¸ ë³´ì • (ì „ë¼ë„)
            text = text.replace(/ì‰ê»˜/g, 'ê·¸ë˜');
            text = text.replace(/~ë¼ìš°/g, '~ì˜ˆìš”');
            
            // ì¶•ì•½ ë°œìŒ ë³´ì •
            text = text.replace(/ìˆ˜í™•ìº¤/g, 'ìˆ˜í™•í–ˆ');
            text = text.replace(/íŒ”ì•˜ìŠ´/g, 'íŒ”ì•˜ìŠµë‹ˆë‹¤');
            text = text.replace(/ìº¤ìŠ´/g, 'ìº¤ìŠµë‹ˆë‹¤');
            
            // ìˆ«ì ë°œìŒ ë³´ì •
            text = text.replace(/ë¹½/g, 'ë°±');
            text = text.replace(/ì³”/g, 'ì²œ');
            text = text.replace(/ë§Œ/g, 'ë§Œ');
            
            // ë‹¨ìœ„ ë°œìŒ ë³´ì •
            text = text.replace(/ìƒì§œ/g, 'ìƒì');
            text = text.replace(/í‚¬ë¡œê·¸ëŒ/g, 'í‚¬ë¡œ');
            text = text.replace(/ì¼€ì´ì§€/g, 'kg');
            text = text.replace(/ë½€ëŒ€/g, 'í¬ëŒ€');
            
            // ì‘ë¬¼ëª… ë°œìŒ ë³´ì •
            text = text.replace(/í† ë§ˆë˜/g, 'í† ë§ˆí† ');
            text = text.replace(/ì˜¤ì´ì´/g, 'ì˜¤ì´');
            text = text.replace(/ë¹ í”„ë¦¬ì¹´/g, 'íŒŒí”„ë¦¬ì¹´');
            text = text.replace(/ë¸Œë¡œê¼´ë¦¬/g, 'ë¸Œë¡œì½œë¦¬');
            text = text.replace(/ìŒì¶”/g, 'ìƒì¶”');
            
            // ë†ì•½ ê´€ë ¨ ë°œìŒ ë³´ì •
            text = text.replace(/ë†ì•½/g, 'ë†ì•½');
            text = text.replace(/ì‚´ì¶©ì©¨/g, 'ì‚´ì¶©ì œ');
            text = text.replace(/ì‚´ê· ì©¨/g, 'ì‚´ê· ì œ');
            text = text.replace(/ì œì´ˆì©¨/g, 'ì œì´ˆì œ');
            text = text.replace(/ì•½ì°Œê¸°/g, 'ì•½ì¹˜ê¸°');
            text = text.replace(/ë¹¨í¬/g, 'ì‚´í¬');
            
            // í’ˆì§ˆ ë°œìŒ ë³´ì •
            text = text.replace(/íŠ¹í’/g, 'íŠ¹í’ˆ');
            text = text.replace(/ìƒí’/g, 'ìƒí’ˆ');
            text = text.replace(/ì¼ë“±ê¸‰/g, '1ë“±ê¸‰');
            text = text.replace(/ì´ë“±ê¸‰/g, '2ë“±ê¸‰');
            
            // ì¶œí•˜ì²˜ ë°œìŒ ë³´ì •
            text = text.replace(/ë†í˜‘/g, 'ë†í˜‘');
            text = text.replace(/ë„ë§¤ì‹œì¥/g, 'ë„ë§¤ì‹œì¥');
            text = text.replace(/ë§ˆíŠ¸/g, 'ë§ˆíŠ¸');
            
            // ë¶ˆí•„ìš”í•œ ì¡°ì‚¬/ì–´ë¯¸ ì œê±°
            text = text.replace(/~ìš”$/g, '');
            text = text.replace(/~ã…‡/g, '');
            
            return text;
        }

        // ë§ˆì´í¬ í† ê¸€
        function toggleMic() {
            if (!recognition) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                isListening = true;
                document.getElementById('mic-status').textContent = 'ğŸ”´ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
                recognition.start();
            }
        }

        // í…ìŠ¤íŠ¸ ë¶„ì„
        function analyzeText() {
            let text = document.getElementById('input-text').value.trim();
            if (!text) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // í•œê¸€ ìˆ«ì ë³€í™˜
            text = text.replace(/ë°±/g, '100').replace(/ì²œ/g, '1000');
            text = text.replace(/ì˜¤ì‹­/g, '50').replace(/ì‹­/g, '10');

            const crops = ['ì‚¬ê³¼', 'ë°°', 'í¬ë„', 'ê°', 'ë³µìˆ­ì•„', 'ìë‘', 'ë°¤', 'ëŒ€ì¶”', 'ë§¤ì‹¤', 'ì‚´êµ¬', 'ì•µë‘', 'ê°ê·¤', 'ê·¤', 'í•œë¼ë´‰', 'ì²œí˜œí–¥', 'ë ˆë“œí–¥', 'ë”¸ê¸°', 'ë¸”ë£¨ë² ë¦¬', 'í‚¤ìœ„', 'ë¬´í™”ê³¼', 'ì„ë¥˜', 'ì˜¤ë””',
                          'í† ë§ˆí† ', 'ì˜¤ì´', 'ê³ ì¶”', 'ê°€ì§€', 'í˜¸ë°•', 'í”¼ë§', 'íŒŒí”„ë¦¬ì¹´', 'ìƒì¶”', 'ë°°ì¶”', 'ë¬´', 'ë‹¹ê·¼', 'ì–‘íŒŒ', 'ë§ˆëŠ˜', 'íŒŒ', 'ìª½íŒŒ', 'ëŒ€íŒŒ', 'ì‹œê¸ˆì¹˜', 'ê¹»ì', 'ë¸Œë¡œì½œë¦¬',
                          'ì½©', 'ì™„ë‘ì½©', 'ê°•ë‚­ì½©', 'ë•…ì½©', 'ê°ì', 'ê³ êµ¬ë§ˆ', 'ê³ êµ¬ë§ˆìˆœ', 'ìƒê°•', 'ìš°ì—‰', 'ì—°ê·¼',
                          'ë²¼', 'ìŒ€', 'ë³´ë¦¬', 'ë°€', 'ì˜¥ìˆ˜ìˆ˜', 'íŒ¥', 'ë…¹ë‘', 'ìˆ˜ìˆ˜', 'ì¡°', 'ê¸°ì¥', 'ì°¸ê¹¨'];
            const harvestTasks = ['ìˆ˜í™•', 'ë”°', 'ë² ', 'ìº', 'ë”°ê¸°', 'ë² ê¸°', 'ìºê¸°', 'ê±°ë‘ê¸°'];
            const shipmentTasks = ['ì¶œí•˜', 'íŒë§¤', 'íŒ”', 'íŒ”ì•˜', 'ë‚©í’ˆ', 'ë°°ì†¡', 'ìš´ì†¡', 'ì§ê±°ë˜', 'ë„ë§¤'];
            const qualities = ['íŠ¹í’ˆ', 'ìƒí’ˆ', 'ì¤‘í’ˆ', 'í•˜í’ˆ', 'Aê¸‰', 'Bê¸‰', 'Cê¸‰', '1ë“±ê¸‰', '2ë“±ê¸‰', '3ë“±ê¸‰'];
            const buyers = ['ë†í˜‘', 'ë„ë§¤ì‹œì¥', 'ë§ˆíŠ¸', 'ëŒ€í˜•ë§ˆíŠ¸', 'ì§ê±°ë˜', 'ì†Œë¹„ì', 'ë¡œì»¬í‘¸ë“œ', 'ì˜¨ë¼ì¸', 'ì§íŒì¥'];
            const storages = ['ì €ì˜¨ì°½ê³ ', 'ëƒ‰ì¥ê³ ', 'ì°½ê³ ', 'ì €ì¥', 'ë³´ê´€', 'ëƒ‰ë™', 'ì‹¤ì˜¨'];

            let crop = 'ë¯¸ë¶„ë¥˜';
            let task = 'ë¯¸ë¶„ë¥˜';
            let quantity = '';
            let unit = '';
            let quality = '';
            let buyer = '';
            let storage = '';

            crops.forEach(c => { if (text.includes(c)) crop = c; });
            harvestTasks.forEach(t => { if (text.includes(t)) task = 'ìˆ˜í™•'; });
            shipmentTasks.forEach(t => { if (text.includes(t)) task = 'ì¶œí•˜'; });
            qualities.forEach(q => { if (text.includes(q)) quality = q; });
            buyers.forEach(b => { if (text.includes(b)) buyer = b; });
            storages.forEach(s => { if (text.includes(s)) storage = s; });

            const qMatch = text.match(/(\d+)\s*(ìƒì|í‚¬ë¡œ|kg|í¬ëŒ€|ê°œ)/i);
            if (qMatch) {
                quantity = qMatch[1];
                unit = qMatch[2];
            }

            currentRecord = {
                id: Date.now(),
                date: new Date().toLocaleString('ko-KR'),
                rawText: text,
                crop: crop,
                task: task,
                quantity: quantity,
                unit: unit,
                quality: quality,
                buyer: buyer,
                storage: storage,
                timestamp: Date.now()
            };

            showInputView();
        }

        // ê¸°ë¡ ì €ì¥
        function saveRecord() {
            if (currentRecord) {
                records.unshift(currentRecord);
                saveData();
                
                // ìŒì„± ëª¨ë“œì—ì„œëŠ” ê°„ë‹¨í•œ ì•Œë¦¼ë§Œ
                if (inputMode === 'voice') {
                    // ì €ì¥ ì„±ê³µ í”¼ë“œë°±
                    const status = document.getElementById('mic-status');
                    if (status) {
                        status.textContent = 'âœ… ì˜ë†ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                        status.style.color = '#16a34a';
                        
                        // 3ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ
                        setTimeout(() => {
                            status.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì”€í•˜ì„¸ìš”';
                            status.style.color = '#374151';
                        }, 3000);
                    }
                } else {
                    alert('ì˜ë†ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
                }
                
                currentRecord = null;
                document.getElementById('input-text').value = '';
                
                // ì…ë ¥ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    showInputView();
                }, 500);
                
                updateRecordCount();
            }
        }

        // ê¸°ë¡ ì‚­ì œ
        function deleteRecord(id) {
            if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                records = records.filter(r => r.id !== id);
                saveData();
                showListView();
            }
        }

        // ì˜ë†ì¼ì§€ ì¶œë ¥ í™”ë©´
        function showReportView() {
            if (records.length === 0) {
                document.getElementById('content').innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ê¸°ë¡ì´ ì—†ì–´ì„œ ì˜ë†ì¼ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div></div>';
                return;
            }

            // ì›”ë³„ ë°ì´í„° ê·¸ë£¹í™”
            const monthlyData = {};
            records.forEach(record => {
                const date = new Date(record.timestamp);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = [];
                }
                monthlyData[yearMonth].push(record);
            });

            let html = '<div class="card">';
            html += '<h3>ğŸ“‹ ì˜ë†ì¼ì§€ ì¶œë ¥</h3>';
            html += '<p style="margin-bottom: 1rem; color: #6b7280;">ì¡°íšŒí•  ì›” ì„ íƒ:</p>';
            html += '<select id="month-select" onchange="generateReport()" style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; margin-bottom: 1.5rem;">';
            html += '<option value="">-- ì›” ì„ íƒ --</option>';
            
            Object.keys(monthlyData).sort().reverse().forEach(month => {
                const [year, m] = month.split('-');
                html += `<option value="${month}">${year}ë…„ ${parseInt(m)}ì›”</option>`;
            });
            
            html += '</select>';
            html += '<div id="report-container"></div>';
            html += '</div>';

            document.getElementById('content').innerHTML = html;
        }

        // ì›”ë³„ ë¦¬í¬íŠ¸ ìƒì„±
        function generateReport() {
            const selectedMonth = document.getElementById('month-select').value;
            if (!selectedMonth) {
                document.getElementById('report-container').innerHTML = '';
                return;
            }

            const monthRecords = records.filter(record => {
                const date = new Date(record.timestamp);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return yearMonth === selectedMonth;
            });

            // ì¼ë³„ ë°ì´í„° ê·¸ë£¹í™”
            const dailyData = {};
            monthRecords.forEach(record => {
                const date = new Date(record.timestamp);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = [];
                }
                dailyData[dateKey].push(record);
            });

            const [year, month] = selectedMonth.split('-');
            
            let html = '<div style="background: white; padding: 2rem; border: 2px solid #e5e7eb; border-radius: 1rem;">';
            html += '<div style="text-align: center; margin-bottom: 2rem; border-bottom: 3px solid #16a34a; padding-bottom: 1rem;">';
            html += '<h2 style="font-size: 2rem; color: #1f2937; margin-bottom: 0.5rem;">ì˜ë†ì¼ì§€</h2>';
            html += `<p style="font-size: 1.2rem; color: #6b7280;">${year}ë…„ ${parseInt(month)}ì›”</p>`;
            html += '</div>';

            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">';
            html += '<thead>';
            html += '<tr style="background: #f3f4f6; border: 2px solid #374151;">';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">ë…„ì›”ì¼</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 6%;">ì‹œê°</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 18%;">ì£¼ìš” ë†ì‘ì—…</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 20%;">ë†ìì¬ ì‚¬ìš©ë‚´ì—­<br>(ë¹„ë£Œ, ì•½ì¬)</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 22%;">ìƒì‚°, ì¶œí•˜ ë‚´ì—­</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">ì˜¨ë„<br>(â„ƒ)</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">ìŠµë„<br>(%)</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';

            const sortedDates = Object.keys(dailyData).sort();
            
            sortedDates.forEach(dateKey => {
                const dayRecords = dailyData[dateKey];
                const [y, m, d] = dateKey.split('-');
                
                const mainWorks = [];
                const productions = [];
                const materials = ['-'];
                
                let timeText = '';
                
                // ëœë¤ ì˜¨ë„/ìŠµë„ ìƒì„± (ì‹¤ì œë¡œëŠ” ë‚ ì”¨ API ì‚¬ìš©)
                const temperature = Math.floor(Math.random() * 15) + 15; // 15-30ë„
                const humidity = Math.floor(Math.random() * 30) + 50; // 50-80%

                dayRecords.forEach(record => {
                    // ì£¼ìš” ë†ì‘ì—…
                    if (record.task !== 'ë¯¸ë¶„ë¥˜') {
                        const workText = `${record.crop} ${record.task}`;
                        if (!mainWorks.includes(workText)) {
                            mainWorks.push(workText);
                        }
                    }

                    // ìƒì‚°/ì¶œí•˜ ë‚´ì—­
                    let productionText = `${record.crop} ${record.task}`;
                    const details = [];
                    if (record.quantity && record.unit) {
                        details.push(`${record.quantity}${record.unit}`);
                    }
                    if (record.quality) {
                        details.push(record.quality);
                    }
                    if (record.storage) {
                        details.push(record.storage);
                    }
                    if (record.buyer) {
                        details.push(record.buyer);
                    }
                    
                    if (details.length > 0) {
                        productionText += ` (${details.join(', ')})`;
                    }
                    
                    if (!productions.includes(productionText)) {
                        productions.push(productionText);
                    }

                    // ì‹œê° ì •ë³´ (ì²« ë²ˆì§¸ ê¸°ë¡ë§Œ)
                    if (!timeText) {
                        const recordDate = new Date(record.timestamp);
                        const hours = String(recordDate.getHours()).padStart(2, '0');
                        const minutes = String(recordDate.getMinutes()).padStart(2, '0');
                        timeText = `${hours}:${minutes}`;
                    }
                });

                html += '<tr>';
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${parseInt(m)}/${parseInt(d)}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center;">${timeText}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${mainWorks.join('<br>') || '-'}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${materials.join('<br>')}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${productions.join('<br>') || '-'}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${temperature}â„ƒ</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${humidity}%</td>`;
                html += '</tr>';
            });

            // ë¹ˆ í–‰ ì¶”ê°€ (ìµœì†Œ 6í–‰ ìœ ì§€)
            const emptyRows = Math.max(0, 6 - sortedDates.length);
            for (let i = 0; i < emptyRows; i++) {
                html += '<tr>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '</table>';

            html += '<div style="text-align: center;">';
            html += '<button onclick="window.print()" class="btn" style="width: auto; padding: 1rem 2rem;">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>';
            html += '</div>';

            html += '</div>';

            document.getElementById('report-container').innerHTML = html;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            loadData();
            initSpeech();
            showInputView();
        };
    </script>
</body>
</html>
