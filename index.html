<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌾 영농일지</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .logo-img {
            height: 50px;
            width: auto;
        }
        
        .header h1 {
            color: #15803d;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header-badge {
            background: #16a34a;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .nav button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #374151;
        }
        
        .nav button.active {
            background: #16a34a;
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .mode-switch {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .mode-switch button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
        }
        
        .mode-switch button.active {
            background: #16a34a;
            color: white;
        }
        
        .mic-container {
            text-align: center;
            padding: 2rem 0;
        }
        
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            font-size: 3rem;
            cursor: pointer;
            margin-bottom: 1rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            background: #16a34a;
            transition: all 0.2s;
        }
        
        .mic-button:hover {
            transform: scale(1.05);
        }
        
        .mic-button.listening {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .mic-status {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            resize: none;
            font-family: inherit;
            margin-bottom: 1rem;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            background: #16a34a;
            color: white;
        }
        
        .btn:hover {
            background: #15803d;
        }
        
        .info-box {
            background: #dbeafe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .info-box p {
            color: #1e40af;
            font-size: 0.9rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #bbf7d0;
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #bfdbfe;
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #e9d5ff;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>🌾 음성기반 농산물이력추적관리 보고서 생성시스템<span class="header-badge">작업자 모드</span></h1>
                <p><strong>팀명:</strong> NDG | <strong>소속:</strong> 재능대학교</p>
                <p style="margin-top: 0.75rem; color: #6b7280;">음성이나 텍스트로 간편하게 영농 활동을 기록하세요</p>
            </div>
            <div class="header-logo">
                <svg width="80" height="50" viewBox="0 0 80 50" xmlns="http://www.w3.org/2000/svg">
                    <!-- JEI 로고 (빨간색) -->
                    <text x="5" y="38" font-family="Arial Black, Arial, sans-serif" font-size="32" font-weight="900" fill="#DC143C" letter-spacing="-1">JEI</text>
                </svg>
            </div>
        </div>

        <div class="nav">
            <button onclick="showTab('input')" class="active" id="btn-input">📝 일지 작성</button>
            <button onclick="showTab('list')" id="btn-list">📅 목록 (<span id="count">0</span>)</button>
            <button onclick="showTab('stats')" id="btn-stats">📊 통계</button>
            <button onclick="showTab('report')" id="btn-report">📋 영농일지</button>
        </div>

        <div id="content"></div>
    </div>

    <script>
        let records = [];
        let currentRecord = null;
        let recognition = null;
        let isListening = false;
        let inputMode = 'voice';

        // localStorage에서 데이터 불러오기
        function loadData() {
            const saved = localStorage.getItem('farmRecords');
            if (saved) {
                records = JSON.parse(saved);
            }
            updateCount();
        }

        // localStorage에 저장
        function saveData() {
            localStorage.setItem('farmRecords', JSON.stringify(records));
            updateCount();
        }

        // 기록 개수 업데이트
        function updateCount() {
            document.getElementById('count').textContent = records.length;
        }

        // 탭 전환
        function showTab(tab) {
            document.getElementById('btn-input').classList.remove('active');
            document.getElementById('btn-list').classList.remove('active');
            document.getElementById('btn-stats').classList.remove('active');
            document.getElementById('btn-report').classList.remove('active');
            
            if (tab === 'input') {
                document.getElementById('btn-input').classList.add('active');
                showInputView();
            } else if (tab === 'list') {
                document.getElementById('btn-list').classList.add('active');
                showListView();
            } else if (tab === 'stats') {
                document.getElementById('btn-stats').classList.add('active');
                showStatsView();
            } else if (tab === 'report') {
                document.getElementById('btn-report').classList.add('active');
                showReportView();
            }
        }

        // 입력 모드 전환
        function switchMode(mode) {
            inputMode = mode;
            showInputView();
        }

        // 일지 작성 화면
        function showInputView() {
            let html = '<div class="card">';
            html += '<div class="mode-switch">';
            html += `<button class="${inputMode === 'voice' ? 'active' : ''}" onclick="switchMode('voice')">🎤 음성 입력</button>`;
            html += `<button class="${inputMode === 'text' ? 'active' : ''}" onclick="switchMode('text')">⌨️ 텍스트 입력</button>`;
            html += '</div>';

            if (inputMode === 'voice') {
                html += '<h3>🎤 음성으로 말씀해주세요</h3>';
                html += '<div class="mic-container">';
                html += '<button class="mic-button" onclick="toggleMic()">🎤</button>';
                html += '<p class="mic-status" id="mic-status">마이크 버튼을 눌러 말씀하세요</p>';
                html += '<p style="color: #6b7280; font-size: 0.9rem;">예: "사과 100상자 수확했어 특품"</p>';
                html += '</div>';
                html += '<input type="text" id="input-text" style="display:none;">';
            } else {
                html += '<h3>📝 영농 활동 입력</h3>';
                html += '<textarea id="input-text" rows="4" placeholder="예: 사과 100상자 수확했어, 포도 50킬로 농협에 출하했어"></textarea>';
                html += '<button class="btn" onclick="analyzeText()">🔨 분석하기</button>';
            }

            html += '<div class="info-box">';
            html += '<p>💡 <strong>입력 예시:</strong></p>';
            html += '<p style="margin-top: 0.5rem;">• "사과 백상자"</p>';
            html += '<p>• "포도 수확"</p>';
            html += '<p>• "토마토 약쳤어"</p>';
            html += '<p>• "배추 팔았어"</p>';
            html += '<p>• "딸기 특품"</p>';
            html += '</div></div>';

            if (currentRecord) {
                html += '<div class="card">';
                html += '<h3>✅ 자동 생성된 영농일지</h3>';
                html += `<p style="margin-bottom: 1rem;">입력: "${currentRecord.rawText}"</p>`;
                html += '<div class="grid">';
                html += `<div class="stat-card green"><strong>🌱 작물:</strong> ${currentRecord.crop}</div>`;
                html += `<div class="stat-card blue"><strong>🔧 작업:</strong> ${currentRecord.task}</div>`;
                if (currentRecord.quantity) {
                    html += `<div class="stat-card purple"><strong>📦 수량:</strong> ${currentRecord.quantity}${currentRecord.unit}</div>`;
                }
                if (currentRecord.quality) {
                    html += `<div class="stat-card purple"><strong>⭐ 품질:</strong> ${currentRecord.quality}</div>`;
                }
                if (currentRecord.buyer) {
                    html += `<div class="stat-card blue"><strong>🏪 출하처:</strong> ${currentRecord.buyer}</div>`;
                }
                if (currentRecord.storage) {
                    html += `<div class="stat-card green"><strong>📦 저장:</strong> ${currentRecord.storage}</div>`;
                }
                html += '</div>';
                html += '<button class="btn" onclick="saveRecord()">💾 영농일지 저장하기</button>';
                html += '</div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        // 목록 화면
        function showListView() {
            let html = '<div class="card"><h3>📅 영농일지 목록</h3>';
            
            if (records.length === 0) {
                html += '<div class="empty-state">';
                html += '<div class="empty-icon">🔭</div>';
                html += '<p>아직 기록된 영농일지가 없습니다.</p>';
                html += '</div>';
            } else {
                records.forEach(record => {
                    html += '<div style="border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">';
                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    html += `<span style="color: #6b7280;">${record.date}</span>`;
                    html += `<button onclick="deleteRecord(${record.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">🗑️</button>`;
                    html += '</div>';
                    html += `<p><strong>🌱 ${record.crop}</strong> | <strong>🔧 ${record.task}</strong>`;
                    if (record.quantity) html += ` | 📦 ${record.quantity}${record.unit}`;
                    if (record.quality) html += ` | ⭐ ${record.quality}`;
                    if (record.buyer) html += ` | 🏪 ${record.buyer}`;
                    html += '</p>';
                    html += `<p style="color: #6b7280; font-style: italic; margin-top: 0.5rem;">"${record.rawText}"</p>`;
                    html += '</div>';
                });
            }
            
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        // 통계 화면
        function showStatsView() {
            if (records.length === 0) {
                document.getElementById('content').innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">📊</div><p>통계를 보려면 먼저 영농일지를 작성해주세요!</p></div></div>';
                return;
            }

            const cropCategories = {
                '과수류': ['사과', '배', '포도', '감', '복숭아', '자두', '밤', '대추', '매실', '살구', '앵두', '감귤', '귤', '한라봉', '천혜향', '레드향', '딸기', '블루베리', '키위', '무화과', '석류', '오디'],
                '채소류': ['토마토', '오이', '고추', '가지', '호박', '피망', '파프리카', '상추', '배추', '무', '당근', '양파', '마늘', '파', '쪽파', '대파', '시금치', '깻잎', '브로콜리'],
                '두류/서류': ['콩', '완두콩', '강낭콩', '땅콩', '감자', '고구마', '고구마순', '생강', '우엉', '연근'],
                '곡물류': ['벼', '쌀', '보리', '밀', '옥수수', '팥', '녹두', '수수', '조', '기장', '참깨']
            };

            const categorizedCrops = {};
            const crops = new Set();
            const tasks = new Set();
            const qualities = {};
            const buyers = {};
            const storages = {};
            
            records.forEach(r => {
                if (r.crop !== '미분류') {
                    crops.add(r.crop);
                    
                    // 작물 카테고리 분류
                    let foundCategory = false;
                    for (const [category, cropList] of Object.entries(cropCategories)) {
                        if (cropList.includes(r.crop)) {
                            if (!categorizedCrops[category]) categorizedCrops[category] = new Set();
                            categorizedCrops[category].add(r.crop);
                            foundCategory = true;
                            break;
                        }
                    }
                    if (!foundCategory) {
                        if (!categorizedCrops['기타']) categorizedCrops['기타'] = new Set();
                        categorizedCrops['기타'].add(r.crop);
                    }
                }
                
                if (r.task !== '미분류') tasks.add(r.task);
                if (r.quality) qualities[r.quality] = (qualities[r.quality] || 0) + 1;
                if (r.buyer) buyers[r.buyer] = (buyers[r.buyer] || 0) + 1;
                if (r.storage) storages[r.storage] = (storages[r.storage] || 0) + 1;
            });

            let html = '<div class="card">';
            html += '<h3>📊 전체 통계</h3>';
            html += '<div class="grid">';
            html += `<div class="stat-card green"><h2 style="font-size: 2.5rem; color: #15803d;">${crops.size}</h2><p>작물 종류</p></div>`;
            html += `<div class="stat-card blue"><h2 style="font-size: 2.5rem; color: #1e40af;">${tasks.size}</h2><p>작업 종류</p></div>`;
            html += `<div class="stat-card purple"><h2 style="font-size: 2.5rem; color: #7c3aed;">${records.length}</h2><p>총 기록</p></div>`;
            html += '</div></div>';

            // 작물 카테고리별 표시
            const categoryIcons = {
                '과수류': '🍎',
                '채소류': '🥬',
                '두류/서류': '🥔',
                '곡물류': '🌾',
                '기타': '🌿'
            };

            html += '<div class="card"><h3>🌱 작물 분류</h3>';
            
            for (const [category, cropSet] of Object.entries(categorizedCrops)) {
                const icon = categoryIcons[category] || '🌱';
                const cropArray = Array.from(cropSet);
                
                html += `<div style="margin-bottom: 1.5rem;">`;
                html += `<h4 style="color: #1f2937; font-size: 1.1rem; margin-bottom: 0.75rem; font-weight: 600;">${icon} ${category} (${cropArray.length}종)</h4>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                
                cropArray.forEach(crop => {
                    html += `<span style="background: #f0fdf4; color: #15803d; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #bbf7d0; font-weight: 500;">${crop}</span>`;
                });
                
                html += `</div></div>`;
            }
            
            html += '</div>';

            // 작업 종류
            if (tasks.size > 0) {
                html += '<div class="card"><h3>🔧 작업 종류</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Array.from(tasks).forEach(task => {
                    html += `<span style="background: #eff6ff; color: #1e40af; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #bfdbfe; font-weight: 500;">${task}</span>`;
                });
                html += '</div></div>';
            }

            // 품질/등급
            if (Object.keys(qualities).length > 0) {
                html += '<div class="card"><h3>⭐ 품질/등급</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(qualities).sort((a, b) => b[1] - a[1]).forEach(([q, count]) => {
                    html += `<span style="background: #fef2f2; color: #dc2626; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #fecaca; font-weight: 500;">${q} <span style="background: #dc2626; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}건</span></span>`;
                });
                html += '</div></div>';
            }

            // 저장 장소
            if (Object.keys(storages).length > 0) {
                html += '<div class="card"><h3>🏭 저장 장소</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(storages).sort((a, b) => b[1] - a[1]).forEach(([s, count]) => {
                    html += `<span style="background: #faf5ff; color: #7c3aed; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #e9d5ff; font-weight: 500;">${s} <span style="background: #7c3aed; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}건</span></span>`;
                });
                html += '</div></div>';
            }

            // 출하처/판매처
            if (Object.keys(buyers).length > 0) {
                html += '<div class="card"><h3>🏪 출하처/판매처</h3><div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                Object.entries(buyers).sort((a, b) => b[1] - a[1]).forEach(([b, count]) => {
                    html += `<span style="background: #fff7ed; color: #ea580c; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #fed7aa; font-weight: 500;">${b} <span style="background: #ea580c; color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">${count}건</span></span>`;
                });
                html += '</div></div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        // 음성 인식 초기화
        function initSpeech() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 5; // 더 많은 대안 제공

                recognition.onresult = (event) => {
                    let text = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            text = event.results[i][0].transcript;
                            break;
                        }
                    }
                    
                    if (text) {
                        // 한국어 발음 정규화
                        text = normalizePronunciation(text);
                        document.getElementById('input-text').value = text;
                        
                        // 자동 분석 및 저장
                        analyzeText();
                        
                        // 1초 후 자동 저장 (사용자가 확인할 시간 제공)
                        setTimeout(() => {
                            if (currentRecord) {
                                saveRecord();
                            }
                        }, 1000);
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    const status = document.getElementById('mic-status');
                    if (status) status.textContent = '마이크 버튼을 눌러 말씀하세요';
                };
            }
        }

        // 한국어 발음 정규화 함수
        function normalizePronunciation(text) {
            // 받침 발음 보정
            text = text.replace(/샤과/g, '사과');
            text = text.replace(/빠/g, '배');
            text = text.replace(/뽀도/g, '포도');
            text = text.replace(/깜/g, '감');
            
            // 이중모음 발음 보정
            text = text.replace(/데추/g, '대추');
            text = text.replace(/메실/g, '매실');
            text = text.replace(/패/g, '배');
            
            // 된소리/거센소리 보정
            text = text.replace(/까지/g, '가지');
            text = text.replace(/빠추/g, '배추');
            text = text.replace(/뽀관/g, '보관');
            text = text.replace(/쭈하/g, '출하');
            
            // 비음화 보정
            text = text.replace(/농녹/g, '농협');
            text = text.replace(/십니다/g, '습니다');
            
            // 구어체 발음 보정
            text = text.replace(/캣어/g, '캤어');
            text = text.replace(/땃어/g, '땄어');
            text = text.replace(/팔았어/g, '팔았어');
            text = text.replace(/했써/g, '했어');
            
            // 방언 보정 (경상도)
            text = text.replace(/카이/g, '캐');
            text = text.replace(/뭐노/g, '뭐야');
            text = text.replace(/~카이/g, '~캐');
            
            // 방언 보정 (전라도)
            text = text.replace(/잉께/g, '그래');
            text = text.replace(/~라우/g, '~예요');
            
            // 축약 발음 보정
            text = text.replace(/수확캤/g, '수확했');
            text = text.replace(/팔았슴/g, '팔았습니다');
            text = text.replace(/캤슴/g, '캤습니다');
            
            // 숫자 발음 보정
            text = text.replace(/빽/g, '백');
            text = text.replace(/쳔/g, '천');
            text = text.replace(/만/g, '만');
            
            // 단위 발음 보정
            text = text.replace(/상짜/g, '상자');
            text = text.replace(/킬로그람/g, '킬로');
            text = text.replace(/케이지/g, 'kg');
            text = text.replace(/뽀대/g, '포대');
            
            // 작물명 발음 보정
            text = text.replace(/토마또/g, '토마토');
            text = text.replace(/오이이/g, '오이');
            text = text.replace(/빠프리카/g, '파프리카');
            text = text.replace(/브로꼴리/g, '브로콜리');
            text = text.replace(/쌍추/g, '상추');
            
            // 농약 관련 발음 보정
            text = text.replace(/농약/g, '농약');
            text = text.replace(/살충쩨/g, '살충제');
            text = text.replace(/살균쩨/g, '살균제');
            text = text.replace(/제초쩨/g, '제초제');
            text = text.replace(/약찌기/g, '약치기');
            text = text.replace(/빨포/g, '살포');
            
            // 품질 발음 보정
            text = text.replace(/특풍/g, '특품');
            text = text.replace(/상풍/g, '상품');
            text = text.replace(/일등급/g, '1등급');
            text = text.replace(/이등급/g, '2등급');
            
            // 출하처 발음 보정
            text = text.replace(/농협/g, '농협');
            text = text.replace(/도매시장/g, '도매시장');
            text = text.replace(/마트/g, '마트');
            
            // 불필요한 조사/어미 제거
            text = text.replace(/~요$/g, '');
            text = text.replace(/~ㅇ/g, '');
            
            return text;
        }

        // 마이크 토글
        function toggleMic() {
            if (!recognition) {
                alert('이 브라우저는 음성 인식을 지원하지 않습니다. Chrome을 사용해주세요.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                isListening = true;
                document.getElementById('mic-status').textContent = '🔴 듣고 있습니다...';
                recognition.start();
            }
        }

        // 텍스트 분석
        function analyzeText() {
            let text = document.getElementById('input-text').value.trim();
            if (!text) {
                alert('텍스트를 입력해주세요!');
                return;
            }

            // 한글 숫자 변환
            text = text.replace(/백/g, '100').replace(/천/g, '1000');
            text = text.replace(/오십/g, '50').replace(/십/g, '10');

            const crops = ['사과', '배', '포도', '감', '복숭아', '자두', '밤', '대추', '매실', '살구', '앵두', '감귤', '귤', '한라봉', '천혜향', '레드향', '딸기', '블루베리', '키위', '무화과', '석류', '오디',
                          '토마토', '오이', '고추', '가지', '호박', '피망', '파프리카', '상추', '배추', '무', '당근', '양파', '마늘', '파', '쪽파', '대파', '시금치', '깻잎', '브로콜리',
                          '콩', '완두콩', '강낭콩', '땅콩', '감자', '고구마', '고구마순', '생강', '우엉', '연근',
                          '벼', '쌀', '보리', '밀', '옥수수', '팥', '녹두', '수수', '조', '기장', '참깨'];
            const harvestTasks = ['수확', '따', '베', '캐', '따기', '베기', '캐기', '거두기'];
            const shipmentTasks = ['출하', '판매', '팔', '팔았', '납품', '배송', '운송', '직거래', '도매'];
            const qualities = ['특품', '상품', '중품', '하품', 'A급', 'B급', 'C급', '1등급', '2등급', '3등급'];
            const buyers = ['농협', '도매시장', '마트', '대형마트', '직거래', '소비자', '로컬푸드', '온라인', '직판장'];
            const storages = ['저온창고', '냉장고', '창고', '저장', '보관', '냉동', '실온'];

            let crop = '미분류';
            let task = '미분류';
            let quantity = '';
            let unit = '';
            let quality = '';
            let buyer = '';
            let storage = '';

            crops.forEach(c => { if (text.includes(c)) crop = c; });
            harvestTasks.forEach(t => { if (text.includes(t)) task = '수확'; });
            shipmentTasks.forEach(t => { if (text.includes(t)) task = '출하'; });
            qualities.forEach(q => { if (text.includes(q)) quality = q; });
            buyers.forEach(b => { if (text.includes(b)) buyer = b; });
            storages.forEach(s => { if (text.includes(s)) storage = s; });

            const qMatch = text.match(/(\d+)\s*(상자|킬로|kg|포대|개)/i);
            if (qMatch) {
                quantity = qMatch[1];
                unit = qMatch[2];
            }

            currentRecord = {
                id: Date.now(),
                date: new Date().toLocaleString('ko-KR'),
                rawText: text,
                crop: crop,
                task: task,
                quantity: quantity,
                unit: unit,
                quality: quality,
                buyer: buyer,
                storage: storage,
                timestamp: Date.now()
            };

            showInputView();
        }

        // 기록 저장
        function saveRecord() {
            if (currentRecord) {
                records.unshift(currentRecord);
                saveData();
                
                // 음성 모드에서는 간단한 알림만
                if (inputMode === 'voice') {
                    // 저장 성공 피드백
                    const status = document.getElementById('mic-status');
                    if (status) {
                        status.textContent = '✅ 영농일지가 저장되었습니다!';
                        status.style.color = '#16a34a';
                        
                        // 3초 후 원래 상태로
                        setTimeout(() => {
                            status.textContent = '마이크 버튼을 눌러 말씀하세요';
                            status.style.color = '#374151';
                        }, 3000);
                    }
                } else {
                    alert('영농일지가 저장되었습니다! 📝');
                }
                
                currentRecord = null;
                document.getElementById('input-text').value = '';
                
                // 입력 화면 새로고침
                setTimeout(() => {
                    showInputView();
                }, 500);
                
                updateRecordCount();
            }
        }

        // 기록 삭제
        function deleteRecord(id) {
            if (confirm('이 기록을 삭제하시겠습니까?')) {
                records = records.filter(r => r.id !== id);
                saveData();
                showListView();
            }
        }

        // 영농일지 출력 화면
        function showReportView() {
            if (records.length === 0) {
                document.getElementById('content').innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">📋</div><p>기록이 없어서 영농일지를 생성할 수 없습니다.</p></div></div>';
                return;
            }

            // 월별 데이터 그룹화
            const monthlyData = {};
            records.forEach(record => {
                const date = new Date(record.timestamp);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = [];
                }
                monthlyData[yearMonth].push(record);
            });

            let html = '<div class="card">';
            html += '<h3>📋 영농일지 출력</h3>';
            html += '<p style="margin-bottom: 1rem; color: #6b7280;">조회할 월 선택:</p>';
            html += '<select id="month-select" onchange="generateReport()" style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; margin-bottom: 1.5rem;">';
            html += '<option value="">-- 월 선택 --</option>';
            
            Object.keys(monthlyData).sort().reverse().forEach(month => {
                const [year, m] = month.split('-');
                html += `<option value="${month}">${year}년 ${parseInt(m)}월</option>`;
            });
            
            html += '</select>';
            html += '<div id="report-container"></div>';
            html += '</div>';

            document.getElementById('content').innerHTML = html;
        }

        // 월별 리포트 생성
        function generateReport() {
            const selectedMonth = document.getElementById('month-select').value;
            if (!selectedMonth) {
                document.getElementById('report-container').innerHTML = '';
                return;
            }

            const monthRecords = records.filter(record => {
                const date = new Date(record.timestamp);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return yearMonth === selectedMonth;
            });

            // 일별 데이터 그룹화
            const dailyData = {};
            monthRecords.forEach(record => {
                const date = new Date(record.timestamp);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = [];
                }
                dailyData[dateKey].push(record);
            });

            const [year, month] = selectedMonth.split('-');
            
            let html = '<div style="background: white; padding: 2rem; border: 2px solid #e5e7eb; border-radius: 1rem;">';
            html += '<div style="text-align: center; margin-bottom: 2rem; border-bottom: 3px solid #16a34a; padding-bottom: 1rem;">';
            html += '<h2 style="font-size: 2rem; color: #1f2937; margin-bottom: 0.5rem;">영농일지</h2>';
            html += `<p style="font-size: 1.2rem; color: #6b7280;">${year}년 ${parseInt(month)}월</p>`;
            html += '</div>';

            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">';
            html += '<thead>';
            html += '<tr style="background: #f3f4f6; border: 2px solid #374151;">';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">년월일</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 6%;">시각</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 18%;">주요 농작업</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 20%;">농자재 사용내역<br>(비료, 약재)</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 22%;">생산, 출하 내역</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">온도<br>(℃)</th>';
            html += '<th style="padding: 1rem; border: 1px solid #374151; width: 8%;">습도<br>(%)</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';

            const sortedDates = Object.keys(dailyData).sort();
            
            sortedDates.forEach(dateKey => {
                const dayRecords = dailyData[dateKey];
                const [y, m, d] = dateKey.split('-');
                
                const mainWorks = [];
                const productions = [];
                const materials = ['-'];
                
                let timeText = '';
                
                // 랜덤 온도/습도 생성 (실제로는 날씨 API 사용)
                const temperature = Math.floor(Math.random() * 15) + 15; // 15-30도
                const humidity = Math.floor(Math.random() * 30) + 50; // 50-80%

                dayRecords.forEach(record => {
                    // 주요 농작업
                    if (record.task !== '미분류') {
                        const workText = `${record.crop} ${record.task}`;
                        if (!mainWorks.includes(workText)) {
                            mainWorks.push(workText);
                        }
                    }

                    // 생산/출하 내역
                    let productionText = `${record.crop} ${record.task}`;
                    const details = [];
                    if (record.quantity && record.unit) {
                        details.push(`${record.quantity}${record.unit}`);
                    }
                    if (record.quality) {
                        details.push(record.quality);
                    }
                    if (record.storage) {
                        details.push(record.storage);
                    }
                    if (record.buyer) {
                        details.push(record.buyer);
                    }
                    
                    if (details.length > 0) {
                        productionText += ` (${details.join(', ')})`;
                    }
                    
                    if (!productions.includes(productionText)) {
                        productions.push(productionText);
                    }

                    // 시각 정보 (첫 번째 기록만)
                    if (!timeText) {
                        const recordDate = new Date(record.timestamp);
                        const hours = String(recordDate.getHours()).padStart(2, '0');
                        const minutes = String(recordDate.getMinutes()).padStart(2, '0');
                        timeText = `${hours}:${minutes}`;
                    }
                });

                html += '<tr>';
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${parseInt(m)}/${parseInt(d)}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center;">${timeText}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${mainWorks.join('<br>') || '-'}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${materials.join('<br>')}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; vertical-align: top;">${productions.join('<br>') || '-'}</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${temperature}℃</td>`;
                html += `<td style="padding: 0.75rem; border: 1px solid #d1d5db; text-align: center; font-weight: 600;">${humidity}%</td>`;
                html += '</tr>';
            });

            // 빈 행 추가 (최소 6행 유지)
            const emptyRows = Math.max(0, 6 - sortedDates.length);
            for (let i = 0; i < emptyRows; i++) {
                html += '<tr>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '<td style="padding: 1.5rem; border: 1px solid #d1d5db;">&nbsp;</td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '</table>';

            html += '<div style="text-align: center;">';
            html += '<button onclick="window.print()" class="btn" style="width: auto; padding: 1rem 2rem;">🖨️ 인쇄하기</button>';
            html += '</div>';

            html += '</div>';

            document.getElementById('report-container').innerHTML = html;
        }

        // 페이지 로드 시 실행
        window.onload = function() {
            loadData();
            initSpeech();
            showInputView();
        };
    </script>
</body>
</html>
